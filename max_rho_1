# -*- coding: utf-8 -*-
"""
Created on Mon Feb  2 18:56:20 2026

@author: loren
"""

from __future__ import annotations

from pathlib import Path
import pandas as pd

INPUT_CSV = Path(r"C:\Users\loren\Desktop\Tesi_magi\codes\model_out\DE11140\model_2_final\spacing\model_output_threshold_3p0_20260202_195035.csv")
OUTPUT_CSV = Path(r"C:\Users\loren\Desktop\Tesi_magi\codes\model_out\DE11140\model_2_final\spacing\pixel_station_max_rho_1.csv")

PIXEL_COLUMN = "pixel_id"
STATION_COLUMN = "station_id"
RHO_COLUMN = "rho_1"

OUTPUT_PIXEL_COLUMN = "Pixel_id"
OUTPUT_STATION_COLUMN = "Station_id"
OUTPUT_MAX_RHO_COLUMN = "rho_1_max"
OUTPUT_MEAN_RHO_COLUMN = "rho_1_mean"

def compute_max_rho_per_pixel(
    data: pd.DataFrame,
    *,
    pixel_column: str = PIXEL_COLUMN,
    station_column: str = STATION_COLUMN,
    rho_column: str = RHO_COLUMN,
) -> pd.DataFrame:
    missing = [
        col
        for col in (pixel_column, station_column, rho_column)
        if col not in data.columns
    ]
    if missing:
        raise KeyError(
            "Missing columns in input CSV: " + ", ".join(missing)
        )

    working = data[[pixel_column, station_column, rho_column]].copy()
    working[rho_column] = pd.to_numeric(working[rho_column], errors="coerce")
    working = working.dropna(subset=[rho_column])

    if working.empty:
        return pd.DataFrame(
            columns=[
                OUTPUT_PIXEL_COLUMN,
                OUTPUT_STATION_COLUMN,
                OUTPUT_MAX_RHO_COLUMN,
                OUTPUT_MEAN_RHO_COLUMN,
            ]
        )

    idx = working.groupby(pixel_column)[rho_column].idxmax()
    result = working.loc[idx, [pixel_column, station_column, rho_column]].copy()
    mean_rho = (
        working.groupby(pixel_column, as_index=False)[rho_column]
        .mean()
        .rename(columns={rho_column: OUTPUT_MEAN_RHO_COLUMN})
    )
    result = result.merge(mean_rho, on=pixel_column, how="left")
    result = result.rename(
        columns={
            pixel_column: OUTPUT_PIXEL_COLUMN,
            station_column: OUTPUT_STATION_COLUMN,
            rho_column: OUTPUT_MAX_RHO_COLUMN,
        }
    )
    result = result.sort_values(by=OUTPUT_PIXEL_COLUMN).reset_index(drop=True)
    return result


def run(
    input_csv: str | Path = INPUT_CSV,
    *,
    output_csv: str | Path = OUTPUT_CSV,
    pixel_column: str = PIXEL_COLUMN,
    station_column: str = STATION_COLUMN,
    rho_column: str = RHO_COLUMN,
) -> Path:
    input_path = Path(input_csv)
    if not input_path.exists():
        raise FileNotFoundError(f"Non trovo il file: {input_path}")
    output_path = Path(output_csv)
    output_path.parent.mkdir(parents=True, exist_ok=True)

    data = pd.read_csv(input_path)
    result = compute_max_rho_per_pixel(
        data,
        pixel_column=pixel_column,
        station_column=station_column,
        rho_column=rho_column,
    )
    result.to_csv(output_path, index=False)
    print(result.to_string(index=False))
    print(f"Tabella salvata in: {output_path}")
    return output_path


def main() -> None:
    run()


if __name__ == "__main__":
    main()
